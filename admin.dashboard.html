<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <script type="module">
  import { getAuth, onAuthStateChanged, signOut } 
    from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import { app } from "./app.js";

  const auth = getAuth(app);

  // Ensure only logged-in users can view this page
  onAuthStateChanged(auth, (user) => {
    if (!user) {
      window.location.href = "admin-login.html";
    }
  });

  // Optional: Add logout button functionality
  window.adminLogout = function () {
    signOut(auth).then(() => {
      window.location.href = "admin-login.html";
    });
  }
</script>

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Admin Dashboard</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Loads Firebase + PRODUCT_DATA + INVENTORY + helpers -->
  <script type="module" src="app.js"></script>
</head>

<body class="p-4">

  <div class="container">
    <h1 class="mb-4">ðŸŒ™ Magic Moon â€” Admin Dashboard</h1>

        <!-- ========================= -->
    <!--       SITE STATISTICS     -->
    <!-- ========================= -->
    <div class="row mb-4">
      <!-- Total Views Card -->
      <div class="col-md-4 mb-3">
        <div class="card shadow-sm">
          <div class="card-body">
            <h5 class="card-title mb-1">Total Site Views</h5>
            <p class="text-muted small mb-1">
              All public page loads logged in Firestore.
            </p>
            <p id="totalViews" class="fs-3 fw-bold mb-0">0</p>
          </div>
        </div>
      </div>

      <!-- Views Chart -->
      <div class="col-md-8 mb-3">
        <div class="card shadow-sm">
          <div class="card-body">
            <h5 class="card-title mb-3">Views (Last 7 Days)</h5>
            <canvas id="viewsChart" height="120"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- ========================= -->
    <!--   INVENTORY MANAGEMENT    -->
    <!-- ========================= -->


    <!-- ========================= -->
    <!--   INVENTORY MANAGEMENT    -->
    <!-- ========================= -->
    <h3 class="mt-4">Inventory</h3>
    <div class="table-responsive">
      <table class="table table-bordered align-middle">
        <thead class="table-light">
          <tr>
            <th>Product</th>
            <th>Current Stock</th>
            <th>Add / Remove</th>
            <th>Save</th>
          </tr>
        </thead>
        <tbody id="inventoryTable"></tbody>
      </table>
    </div>

    <hr class="my-5">

    <!-- ========================= -->
    <!--     REAL-TIME SALES       -->
    <!-- ========================= -->
    <h3>Sales History (Real-Time)</h3>
    <p class="text-muted">New orders appear instantly.</p>

    <button id="archiveBtn" class="btn btn-outline-warning btn-sm mb-3">
        Archive orders older than 30 days
    </button>

    <div class="table-responsive">
      <table class="table table-bordered align-middle">
        <thead class="table-light">
          <tr>
            <th>Order ID</th>
            <th>Date</th>
            <th>Items</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody id="salesHistory"></tbody>
      </table>
    </div>

  <a href="admin.archive.html" class="btn btn-outline-secondary mt-4 me-2">
    View Archived Orders
    </a>
    <a href="index.html" class="btn btn-secondary mt-4">Back to Store</a>
    <button class="btn btn-danger mt-4" onclick="adminLogout()">Logout</button>



  <!-- ADMIN PAGE SCRIPT -->
  <script type="module">
    import {
      getFirestore,
      doc,
      setDoc,
      onSnapshot,
      collection,
      updateDoc,
      query,
      where,
      getDocs,
      deleteDoc,
      Timestamp
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // Use the default Firebase app initialized in app.js
    const db = getFirestore();

        /*****************************
     *   SITE VIEW COUNTER       *
     *****************************/
    const viewCountEl = document.getElementById("viewCount");

    onSnapshot(doc(db, "store", "stats"), (snap) => {
      const data = snap.data() || {};
      const views = typeof data.pageViews === "number" ? data.pageViews : 0;
      if (viewCountEl) {
        viewCountEl.textContent = views.toLocaleString();
      }
    });

    /*****************************
     *     REAL-TIME INVENTORY   *
     *****************************/
    const inventoryTable = document.getElementById("inventoryTable");

    // Live listener for inventory document
    onSnapshot(doc(db, "store", "inventory"), (snap) => {
      const inv = snap.data() || {};
      window.INVENTORY = inv; // keep global in sync

      inventoryTable.innerHTML = "";

      Object.entries(inv).forEach(([id, stock]) => {
        const p = window.PRODUCT_DATA[id];
        if (!p) return;

        const row = document.createElement("tr");

        row.innerHTML = `
          <td>${p.name}</td>
          <td id="stock-${id}">${stock}</td>
          <td>
            <input type="number" class="form-control" id="adj-${id}" value="0">
          </td>
          <td>
            <button class="btn btn-primary" data-id="${id}">Save</button>
          </td>
        `;

        inventoryTable.appendChild(row);
      });
    });

    // Save button handler (add / remove stock)
    inventoryTable.addEventListener("click", async (e) => {
      const btn = e.target.closest("button[data-id]");
      if (!btn) return;

      const id = btn.dataset.id;
      const amount = parseInt(document.getElementById(`adj-${id}`).value) || 0;

      const newStock = (window.INVENTORY[id] || 0) + amount;

      await updateDoc(doc(db, "store", "inventory"), {
        [id]: newStock
      });

      alert(`Updated stock for ${window.PRODUCT_DATA[id].name}: ${newStock}`);
    });

    /*****************************
     *   REAL-TIME SALES HISTORY *
     *****************************/
    const salesHistory = document.getElementById("salesHistory");

    onSnapshot(collection(db, "orders"), (snapshot) => {
      salesHistory.innerHTML = "";

      snapshot.forEach((docSnap) => {
        const data = docSnap.data();

        // Date
        const created = data.createdAt?.toDate
          ? data.createdAt.toDate()
          : new Date();

        // Items: handle array or object form
        const itemsArray = Array.isArray(data.items)
          ? data.items
          : Object.entries(data.items || {}).map(([id, item]) => ({
              id,
              ...item
            }));

        const itemsList = itemsArray
          .map(i => `${i.name} (x${i.qty})`)
          .join("<br>");

        const totalDisplay = data.totals?.total || "$0.00";

        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${docSnap.id}</td>
          <td>${created.toLocaleString()}</td>
          <td>${itemsList}</td>
          <td>${totalDisplay}</td>
        `;

        salesHistory.appendChild(row);
      });
    });

    /*****************************
     *   ARCHIVE OLD ORDERS BTN  *
     *****************************/
    const archiveBtn = document.getElementById("archiveBtn");

    archiveBtn.addEventListener("click", async () => {
      const ok = confirm(
        "Archive orders older than 30 days? They will be moved to 'orders_archive' and removed from this list."
      );
      if (!ok) return;

      try {
        // Cutoff: 30 days ago
        const cutoffDate = new Date();
        cutoffDate.setDate(cutoffDate.getDate() - 30);

        const q = query(
          collection(db, "orders"),
          where("createdAt", "<", Timestamp.fromDate(cutoffDate))
        );

        const snap = await getDocs(q);

        if (snap.empty) {
          alert("No orders older than 30 days to archive.");
          return;
        }

        let count = 0;

        for (const docSnap of snap.docs) {
          const data = docSnap.data();

          // Copy into orders_archive with same ID
          await setDoc(doc(db, "orders_archive", docSnap.id), data);

          // Remove from active orders
          await deleteDoc(doc(db, "orders", docSnap.id));

          count++;
        }

        alert(`Archived ${count} old orders.`);
      } catch (err) {
        console.error("Error archiving orders:", err);
        alert("Failed to archive orders. See console for details.");
      }
    });
  </script>

</body>
</html>
